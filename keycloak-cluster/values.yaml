# Keycloak Cluster Helm Chart Values
# This chart deploys a Keycloak instance using the Keycloak Operator CRD

# =========================================================================
# BASIC SETTINGS
# =========================================================================
nameOverride: ""
fullnameOverride: ""

# =========================================================================
# INSTANCES & HIGH AVAILABILITY
# =========================================================================
instances: 3

# =========================================================================
# DATABASE CONFIGURATION
# =========================================================================
db:
  vendor: postgres
  host: postgresql
  port: 5432
  database: keycloak
  # Reference to existing secret for DB credentials
  usernameSecret:
    name: keycloak-db-secret
    key: username
  passwordSecret:
    name: keycloak-db-secret
    key: password
  # Connection pool configuration for production
  poolInitialSize: 10
  poolMinSize: 20
  poolMaxSize: 40

# Create DB secret (set to false if using existing secret)
dbSecret:
  create: true
  username: keycloak
  password: changeme

# =========================================================================
# HTTP/TLS CONFIGURATION
# =========================================================================
http:
  # CRITICAL: Keep httpEnabled: false in production if you need TLS
  httpEnabled: true
  # Labels for the Service
  labels:
    app: keycloak
    component: auth-server
  # Annotations for monitoring
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9000"
    prometheus.io/path: "/metrics"

# =========================================================================
# HOSTNAME CONFIGURATION
# =========================================================================
hostname:
  strict: true
  hostname: keycloak.example.com
  backchannelDynamic: false

# =========================================================================
# PROXY CONFIGURATION
# =========================================================================
proxy:
  headers: xforwarded

# =========================================================================
# INGRESS CONFIGURATION (DISABLED - Using Gateway API)
# =========================================================================
ingress:
  enabled: false

# =========================================================================
# GATEWAY API - HTTPRoute
# =========================================================================
httpRoute:
  enabled: true
  parentRefs:
    - name: public-gw
      namespace: kgateway-system
  # Hostnames (uses hostname.hostname by default if not specified)
  hostnames: []

# =========================================================================
# RESOURCE REQUIREMENTS (PRODUCTION)
# =========================================================================
resources:
  requests:
    cpu: 500m
    memory: 1700Mi
  limits:
    cpu: 2000m
    memory: 2Gi

# =========================================================================
# SCHEDULING & AFFINITY (HA BEST PRACTICES)
# =========================================================================
scheduling:
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: kubernetes.io/hostname
      whenUnsatisfiable: DoNotSchedule
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app
                  operator: In
                  values:
                    - keycloak
                - key: app.kubernetes.io/managed-by
                  operator: In
                  values:
                    - keycloak-operator
            topologyKey: kubernetes.io/hostname

# =========================================================================
# PROBE CONFIGURATION (PRODUCTION)
# =========================================================================
readinessProbe:
  periodSeconds: 10
  failureThreshold: 3

livenessProbe:
  periodSeconds: 10
  failureThreshold: 3

startupProbe:
  periodSeconds: 5
  failureThreshold: 30

# =========================================================================
# NETWORK POLICIES
# =========================================================================
networkPolicy:
  enabled: false

# =========================================================================
# UPDATE STRATEGY (PRODUCTION)
# =========================================================================
# Auto: Detects if rolling update is possible (requires 2+ instances)
# RecreateOnImageChange: Scales down on image change (default)
# Explicit: User-controlled via revision field
update:
  strategy: Auto

# =========================================================================
# FEATURES CONFIGURATION
# =========================================================================
features:
  enabled:
    - user-event-metrics
  disabled: []

# =========================================================================
# ADMIN BOOTSTRAPPING
# =========================================================================
bootstrapAdmin:
  user:
    secretName: keycloak-admin-secret

# Create admin secret (set to false if using existing secret)
adminSecret:
  create: true
  username: admin
  password: changeme

# =========================================================================
# ADVANCED CONFIGURATION OPTIONS
# =========================================================================
additionalOptions:
  # Security Hardening
  - name: security-headers-enabled
    value: "true"
  # Performance & Caching
  - name: cache
    value: "ispn"
  # Logging
  - name: log
    value: "console"
  - name: log-level
    value: "WARN"
  - name: log-format
    value: "json"
  # Metrics
  - name: metrics-enabled
    value: "true"
  # HTTP Client Timeouts
  - name: http-client-default-socket-timeout
    value: "5000"
